<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avanzamento posa condotta</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    #map { height: 78vh; border: 1px solid #ddd; border-radius: 10px; }
    .legend { margin: 10px 0; font-size: 14px; color: #444; }
  </style>
</head>

<body>
  <h2>Avanzamento posa condotta</h2>
  <div class="legend">Punti = avanzamento calcolato da <code>done/tot</code> e proiettato sulla geometria.</div>
  <div id="map"></div>

<script>
  const map = L.map("map");

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 20,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  // --- Helpers MultiLineString ---
  function asLineStrings(feature) {
    const g = feature.geometry;
    if (!g) return [];
    if (g.type === "LineString") {
      return [turf.lineString(g.coordinates, feature.properties)];
    }
    if (g.type === "MultiLineString") {
      return g.coordinates.map(coords => turf.lineString(coords, feature.properties));
    }
    return [];
  }

  function lengthMetersOfLineStrings(lines) {
    return lines.reduce((sum, ls) => sum + turf.length(ls, { units: "meters" }), 0);
  }

  function pointAlongMulti(lines, distMeters) {
    let remaining = distMeters;

    for (const ls of lines) {
      const segLen = turf.length(ls, { units: "meters" });
      if (remaining <= segLen) {
        return turf.along(ls, remaining, { units: "meters" });
      }
      remaining -= segLen;
    }

    const last = lines[lines.length - 1];
    const coords = last.geometry.coordinates;
    const lastCoord = coords[coords.length - 1];
    return turf.point(lastCoord);
  }

  // Colori per ditta (hash deterministico)
  function colorForString(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
    const hue = h % 360;
    return `hsl(${hue}, 70%, 40%)`;
  }

  Promise.all([
    fetch("tronchi.geojson").then(r => r.json()),
    fetch("avanzamento.json").then(r => r.json())
  ]).then(([tronchi, avanzamento]) => {

    const bounds = [];

    tronchi.features.forEach(f => {
      const id = (f.properties && (f.properties.fid ?? f.properties.tronco))?.toString();
      if (!id) return;

      const ditta = (f.properties && f.properties.Ditta) ? f.properties.Ditta : "â€”";
      const lines = asLineStrings(f);
      if (lines.length === 0) return;

      const color = colorForString(ditta);
      L.geoJSON(f, { style: { color, weight: 5, opacity: 0.85 } }).addTo(map);

      lines.forEach(ls => {
        const bb = turf.bbox(ls);
        bounds.push([[bb[1], bb[0]], [bb[3], bb[2]]]);
      });

      const a = avanzamento[id];
      if (!a) return;

      const perc = (a.tot > 0) ? Math.max(0, Math.min(a.done / a.tot, 1)) : 0;

      const geoLen = lengthMetersOfLineStrings(lines);
      const dist = geoLen * perc;

      const p = pointAlongMulti(lines, dist);
      const [lng, lat] = p.geometry.coordinates;

      L.circleMarker([lat, lng], {
        radius: 7,
        color: "#d10000",
        fillColor: "#d10000",
        fillOpacity: 1,
        weight: 2
      }).addTo(map).bindPopup(`
        <b>Tronco ${id}</b><br>
        <b>Ditta:</b> ${ditta}<br>
        <b>Posati:</b> ${a.done.toFixed(2)} m<br>
        <b>Totali:</b> ${a.tot.toFixed(2)} m<br>
        <b>Avanzamento:</b> ${(perc * 100).toFixed(1)}%
      `);
    });

    if (bounds.length) {
      const b = bounds.reduce(
        (acc, bb) => acc.extend(L.latLngBounds(bb)),
        L.latLngBounds(bounds[0])
      );
      map.fitBounds(b.pad(0.08));
    } else {
      map.setView([44.99, 9.50], 12);
    }
  })
  .catch(err => {
    console.error(err);
    alert("Errore nel caricamento dei file: controlla che tronchi.geojson e avanzamento.json siano nella stessa cartella di index.html");
  });
</script>

</body>
</html>
