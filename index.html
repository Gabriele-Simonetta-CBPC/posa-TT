<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Avanzamento posa condotta</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 0; }
  header { padding: 12px 16px; border-bottom: 1px solid #ddd; }
  #map { height: calc(100vh - 50px); }
</style>
</head>

<body>
<header><b>Avanzamento posa condotta</b></header>
<div id="map"></div>

<script>
const BASE = window.location.origin + window.location.pathname.replace(/index\.html$/,"");
const CB = Date.now(); // anti-cache

const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

function getTroncoId(props) {
  return props?.tronco ?? props?.Tronco ?? props?.TRONCO ?? null;
}

function getDitta(props) {
  return props?.ditta ?? props?.Ditta ?? props?.DITTA ?? "";
}

// Calcola punto avanzamento su LineString o MultiLineString
function computeProgressPoint(feature, done, tot) {
  const perc = (tot > 0) ? Math.min(done / tot, 1) : 0;
  const totalKm = turf.length(feature, { units: "kilometers" }); // turf supporta MultiLineString
  if (!isFinite(totalKm) || totalKm <= 0) return { perc, point: null, totalM: 0 };

  const totalM = totalKm * 1000;
  const distKm = totalKm * perc;
  const point = turf.along(feature, distKm, { units: "kilometers" });

  return { perc, point, totalM };
}

Promise.all([
  fetch(`${BASE}tronchi.geojson?cb=${CB}`).then(r => {
    if(!r.ok) throw new Error("Impossibile leggere tronchi.geojson");
    return r.json();
  }),
  fetch(`${BASE}avanzamento.json?cb=${CB}`).then(r => {
    if(!r.ok) throw new Error("Impossibile leggere avanzamento.json");
    return r.json();
  })
]).then(([tronchi, avanzamento]) => {

  const layerTronchi = L.geoJSON(tronchi, {
    style: f => ({ color: "#666", weight: 4 }),
    onEachFeature: (f, layer) => {
      const id = getTroncoId(f.properties) ?? "?";
      const ditta = getDitta(f.properties);
      layer.bindTooltip(`Tronco ${id}${ditta ? " - " + ditta : ""}`);
    }
  }).addTo(map);

  // 1 punto per ogni feature del GeoJSON
  tronchi.features.forEach(f => {
    const id = getTroncoId(f.properties);
    if (!id) return;

    const dati = avanzamento[id];
    if (!dati) {
      console.warn("Manca avanzamento per tronco:", id);
      return;
    }

    const done = Number(dati.done) || 0;
    const tot  = Number(dati.tot)  || 0;

    const { perc, point } = computeProgressPoint(f, done, tot);
    if (!point) return;

    const [lng, lat] = point.geometry.coordinates;

    const ditta = getDitta(f.properties);

    L.circleMarker([lat, lng], {
      radius: 7,
      color: "red",
      fillColor: "red",
      fillOpacity: 1
    }).addTo(map).bindPopup(`
      <b>Tronco ${id}</b><br>
      ${ditta ? `<i>${ditta}</i><br>` : ""}
      ${done.toFixed(2)} m / ${tot.toFixed(2)} m<br>
      ${(perc*100).toFixed(1)} %
    `);
  });

  map.fitBounds(layerTronchi.getBounds());

}).catch(err => {
  console.error(err);
  alert("Errore nel caricamento dei file. Apri la console (F12) per dettagli.");
});
</script>
</body>
</html>
