<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Avanzamento posa condotta</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js per calcolo lunghezze -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    body { font-family: Arial; margin: 20px; }
    #map { height: 400px; margin-top: 20px; }
    table { border-collapse: collapse; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<h2>Metri posati per ditta</h2>

<table>
  <thead>
    <tr>
      <th>Ditta</th>
      <th>Metri posati</th>
    </tr>
  </thead>
  <tbody id="tabella"></tbody>
</table>

<div id="map"></div>

<script>
const map = L.map('map').setView([45.0, 9.0], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
  .addTo(map);

fetch("condotte.geojson")
  .then(r => r.json())
  .then(data => {

    const totali = {};

    L.geoJSON(data, {
      onEachFeature: (feature, layer) => {
        const ditta = feature.properties.ditta;
        const metri = turf.length(feature, { units: 'kilometers' }) * 1000;

        totali[ditta] = (totali[ditta] || 0) + metri;

        layer.bindPopup(
          `<b>${ditta}</b><br>${metri.toFixed(1)} m`
        );
      }
    }).addTo(map);

    map.fitBounds(L.geoJSON(data).getBounds());

    const tbody = document.getElementById("tabella");
    for (const ditta in totali) {
      tbody.innerHTML += `
        <tr>
          <td>${ditta}</td>
          <td>${totali[ditta].toFixed(1)}</td>
        </tr>`;
    }
  });
</script>

</body>
</html>
