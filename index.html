<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Avanzamento posa condotta</title>

<link rel="icon" href="data:,">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; }
header { padding:10px 15px; border-bottom:1px solid #ccc; }
#map { height:calc(100vh - 50px); }
</style>
</head>

<body>

<header>
  <b>Avanzamento posa condotta</b>
  <span id="status">caricamentoâ€¦</span>
</header>

<div id="map"></div>

<script>

const statusEl = document.getElementById("status");
function setStatus(t){ statusEl.textContent = t; }

console.log("BOOT OK");

const map = L.map('map').setView([44.99, 9.51], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const CB = Date.now(); // anti cache

console.log("Fetch files...");

Promise.all([
  fetch("tronchi.geojson?cb=" + CB).then(r=>{
    console.log("tronchi status:", r.status);
    if(!r.ok) throw new Error("tronchi.geojson HTTP "+r.status);
    return r.json();
  }),
  fetch("avanzamento.json?cb=" + CB).then(r=>{
    console.log("avanzamento status:", r.status);
    if(!r.ok) throw new Error("avanzamento.json HTTP "+r.status);
    return r.json();
  })
])
.then(([geo, avanz])=>{

  console.log("GeoJSON features:", geo.features.length);
  console.log("Avanz keys:", Object.keys(avanz));

  setStatus("dati caricati");

  const layer = L.geoJSON(geo, {
    style: { color:"#555", weight:4 }
  }).addTo(map);

  map.fitBounds(layer.getBounds());

  geo.features.forEach(f=>{

    const id = f.properties?.tronco;
    if(!id) return;

    const dati = avanz[id];
    if(!dati) return;

    const done = Number(dati.done)||0;
    const tot  = Number(dati.tot)||0;
    if(tot<=0) return;

    try{

      const lengthKm = turf.length(f, {units:"kilometers"});
      const distKm = lengthKm * Math.min(done/tot,1);
      const pt = turf.along(f, distKm, {units:"kilometers"});

      const [lng,lat] = pt.geometry.coordinates;

      L.circleMarker([lat,lng],{
        radius:7,
        color:"red",
        fillColor:"red",
        fillOpacity:1
      }).addTo(map).bindPopup(
        "<b>Tronco "+id+"</b><br>"+
        done.toFixed(2)+" / "+tot.toFixed(2)+" m<br>"+
        ((done/tot)*100).toFixed(1)+" %"
      );

    }catch(e){
      console.error("Errore su tronco", id, e);
    }

  });

})
.catch(err=>{
  console.error("ERRORE GENERALE:", err);
  setStatus("errore caricamento");
  alert(err.message);
});

</script>

</body>
</html>
