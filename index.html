<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Avanzamento posa condotta</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
#map { height: 600px; }
</style>
</head>

<body>
<h2>Avanzamento posa condotta</h2>
<div id="map"></div>

<script>
const map = L.map('map').setView([45.10, 9.12], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

Promise.all([
  fetch("tronchi.geojson").then(r => r.json()),
  fetch("avanzamento.json").then(r => r.json())
]).then(([tronchi, avanzamento]) => {

  const layerTronchi = L.geoJSON(tronchi, {
    style: { color: "#666", weight: 4 }
  }).addTo(map);

  tronchi.features.forEach(f => {
    const id = f.properties.tronco;
    const dati = avanzamento[id];
    if (!dati) return;

    const linea = f;
    const lungTot = turf.length(linea, { units: "meters" });
    const perc = Math.min(dati.done / dati.tot, 1);
    const dist = lungTot * perc;

    const punto = turf.along(linea, dist, { units: "meters" });

    L.circleMarker(
      [punto.geometry.coordinates[1], punto.geometry.coordinates[0]],
      { radius: 7, color: "red", fillColor: "red", fillOpacity: 1 }
    )
    .addTo(map)
    .bindPopup(`
      <b>Tronco ${id}</b><br>
      ${dati.done.toFixed(1)} / ${dati.tot.toFixed(1)} m<br>
      ${(perc*100).toFixed(1)} %
    `);
  });

  map.fitBounds(layerTronchi.getBounds());
});
</script>

</body>
</html>
