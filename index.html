<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PNRR – Posa condotta (Leaflet + GeoJSON + avanzamento.json)</title>

  <!-- =========================================================
       #--LIBRERIE (Leaflet)--#
       ========================================================= -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    /* =========================================================
       #--TEMA BASE--#
       ========================================================= */
    :root{
      --bg: #0f172a;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
      --muted2: rgba(255,255,255,0.55);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, #1e293b 0%, var(--bg) 55%);
      color:var(--text);
      font-family:var(--sans);
    }

    /* =========================================================
       #--LAYOUT PRINCIPALE--#
       ========================================================= */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:12px;
      padding:12px;
      box-sizing:border-box;
    }
    .left, .right{
      border:1px solid var(--stroke);
      border-radius:14px;
      background: var(--panel);
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .left{
      display:flex;
      flex-direction:column;
      min-width:320px;
    }
    .right{
      position:relative;
    }
    #map{
      height:100%;
      width:100%;
    }

    /* =========================================================
       #--HEADER / CONTROLLI--#
       ========================================================= */
    .header{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    }
    .title{
      font-weight:800;
      letter-spacing:0.2px;
      font-size:14.5px;
      margin:0 0 8px 0;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .control-group{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    select, button{
      font-family:var(--sans);
      font-size:13px;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline:none;
    }
    button{
      cursor:pointer;
      background: rgba(255,255,255,0.08);
    }
    button:hover{ background: rgba(255,255,255,0.12); }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      white-space:nowrap;
    }

    /* =========================================================
       #--SOMMA (VISIBILE SOLO IN "COMPRIMI")--#
       NOTA: “somma” = riga a celle (non testo semplice)
       ========================================================= */
    .summary-row{
      display:grid;
      /* titolo + 7 celle: Tronchi, Ditte, Tot, Posati, % , m dal baseline, Δ% dal baseline */
      grid-template-columns: 1.35fr repeat(7, 1fr);
      gap:10px;
      align-items:center;

      padding: 9px 10px;
      margin: 10px 12px 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.18);

      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.35;
      white-space: nowrap;
    }
    .summary-title{ font-weight:800; }
    .summary-cell .k{ opacity:0.78; margin-right:6px; }
    .summary-cell .v{ font-weight:800; }
    .is-hidden{ display:none !important; }

    /* =========================================================
       #--TABELLA--#
       - In modalità "COMPRIMI": righe per ditta (aggregato)
       ========================================================= */
    .table-wrap{
      padding: 0 12px 12px 12px;
      overflow:auto;
      flex:1;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px;
      font-family:var(--mono);
      font-size:12.5px;
      white-space:nowrap;
    }
    thead th{
      text-align:left;
      color: var(--muted);
      font-weight:700;
      padding: 0 10px 6px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    tbody tr{
      background: rgba(0,0,0,0.16);
      border:1px solid var(--stroke);
    }
    tbody td{
      padding: 8px 10px;
      border-top:1px solid rgba(255,255,255,0.07);
      border-bottom:1px solid rgba(255,255,255,0.07);
    }
    tbody tr td:first-child{
      border-left:1px solid rgba(255,255,255,0.07);
      border-top-left-radius:12px;
      border-bottom-left-radius:12px;
      font-weight:800;
    }
    tbody tr td:last-child{
      border-right:1px solid rgba(255,255,255,0.07);
      border-top-right-radius:12px;
      border-bottom-right-radius:12px;
    }
    .muted{ color:var(--muted2); font-weight:600; }
    .pos{ color: var(--text); }
    .neg{ color: var(--text); opacity:0.9; } /* volutamente neutro (niente colori hard-coded) */

    /* =========================================================
       #--RESPONSIVE--#
       ========================================================= */
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .left{ order:2; height:52vh; }
      .right{ order:1; height:48vh; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- =========================================================
         #--PANNELLO SINISTRO (UI + Tabella)--#
         ========================================================= -->
    <aside class="left">

      <!-- =========================================================
           #--HEADER + CONTROLLI--#
           - Selezione data (presa da avanzamento.json)
           - Toggle “Comprimi”
           ========================================================= -->
      <div class="header">
        <p class="title">PNRR · Posa condotta</p>

        <div class="controls">
          <div class="control-group">
            <span class="pill">Baseline: <span id="baselineLabel">2026-01-27</span></span>

            <label class="muted" for="dateSelect" style="margin-left:2px;">Data:</label>
            <select id="dateSelect"></select>
          </div>

          <button id="btnComprimi" type="button" title="Mostra tabella aggregata per ditta">
            Comprimi: OFF
          </button>
        </div>
      </div>

      <!-- =========================================================
           #--SOMMA (visibile SOLO quando Comprimi = ON)--#
           Colonna aggiunta: “m dal 27/01”
           ========================================================= -->
      <div id="summaryRow" class="summary-row is-hidden" aria-hidden="true">
        <div class="summary-cell summary-title">Tutti i tronchi</div>

        <div class="summary-cell"><span class="k">Tronchi:</span> <span id="sumTronchi" class="v">-</span></div>
        <div class="summary-cell"><span class="k">Ditte:</span>   <span id="sumDitte"   class="v">-</span></div>
        <div class="summary-cell"><span class="k">Tot:</span>     <span id="sumTot"     class="v">-</span></div>
        <div class="summary-cell"><span class="k">Posati:</span>  <span id="sumPosati"  class="v">-</span></div>
        <div class="summary-cell"><span class="k">%:</span>       <span id="sumPerc"    class="v">-</span></div>

        <!-- NUOVO: metri posati dal baseline -->
        <div class="summary-cell">
          <span class="k">m dal</span> <span id="sumBaseDate" class="v">2026-01-27</span>:
          <span id="sumMDelta" class="v">-</span>
        </div>

        <div class="summary-cell">
          <span class="k">Δ% dal</span> <span id="sumBaseDate2" class="v">2026-01-27</span>:
          <span id="sumDeltaPerc" class="v">-</span>
        </div>
      </div>

      <!-- =========================================================
           #--TABELLA (in questo file: modalità aggregata per ditta)--#
           - In Comprimi=OFF la tabella resta comunque utile: mostra aggregato
             (se vuoi in OFF una tabella “per tronco”, dimmelo e te la riporto).
           - Colonna aggiunta: “m dal 27/01”
           ========================================================= -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ditta</th>
              <th>Tronchi</th>
              <th>Tot (m)</th>
              <th>Posati (m)</th>
              <th>%</th>
              <th>m dal 27/01</th>
              <th>Δ% dal 27/01</th>
            </tr>
          </thead>
          <tbody id="tbodyDitte">
            <!-- righe generate via JS -->
          </tbody>
        </table>
      </div>
    </aside>

    <!-- =========================================================
         #--MAPPA (Leaflet)--#
         ========================================================= -->
    <main class="right">
      <div id="map"></div>
    </main>

  </div>

  <script>
    /* =========================================================
       #--CONFIG FILE (percorsi)--#
       - Modifica questi path secondo i tuoi file su GitHub Pages
       ========================================================= */
    const CONFIG = {
      GEOJSON_URL: "./tronchi.geojson",         // <-- es: tronchi.geojson
      AVANZ_URL:   "./avanzamento.json",        // <-- es: avanzamento.json
      BASELINE_DATE: "2026-01-27"               // baseline richiesta
    };

    /* =========================================================
       #--STATO APPLICAZIONE--#
       ========================================================= */
    const state = {
      isCompressed: false,
      geojson: null,            // FeatureCollection
      avanzamento: null,        // struttura flessibile (vedi normalizzazione sotto)
      dates: [],                // elenco date disponibili
      selectedDate: null,       // data corrente
      map: null,
      layerTronchi: null
    };

    /* =========================================================
       #--HELPERS: fetch JSON + formattazione--#
       ========================================================= */
    async function loadJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error(`Errore fetch ${url}: ${r.status}`);
      return r.json();
    }

    function fmtMeters(n){
      return `${Number(n || 0).toFixed(2)}`;
    }

    function fmtPerc(n, signed=false){
      const v = Number(n || 0);
      const s = signed ? (v > 0 ? "+" : "") : "";
      return `${s}${v.toFixed(1)}`;
    }

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    /* =========================================================
       #--NORMALIZZAZIONE AVANZAMENTO--#
       Obiettivo: ottenere una funzione:
         getPosatiByDate(date) -> Map(fid -> posati_m)
       e un elenco di date disponibili (state.dates).
       ========================================================= */
    function normalizeAvanzamento(avzRaw){
      // Supporta 2 formati comuni:
      // A) { "2026-01-27": { "2": 150, "3": 0, ... }, "2026-02-11": {...} }
      // B) { "baseline": "...", "dates": ["..."], "byDate": { "2026-..": {...}} }
      // Se il tuo formato è diverso, lo adattiamo in 2 minuti (ma intanto questo copre l’80%).
      let byDate = null;

      if(avzRaw && avzRaw.byDate) byDate = avzRaw.byDate;
      else byDate = avzRaw;

      // ricava le date (chiavi ISO)
      const dates = Object.keys(byDate || {})
        .filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k))
        .sort();

      return { byDate, dates };
    }

    function getPosatiMapForDate(date){
      const byDate = state.avanzamento.byDate;
      const raw = (byDate && byDate[date]) ? byDate[date] : {};
      // raw atteso come oggetto: { "fid": posati_m, ... }
      const m = new Map();
      for(const [fid, pos] of Object.entries(raw)){
        m.set(String(fid), safeNum(pos));
      }
      return m;
    }

    /* =========================================================
       #--LETTURA PROPRIETA' DITTA / FID / LUNGHEZZA DA GEOJSON--#
       - Adatta qui i nomi campo se nel tuo geojson differiscono.
       ========================================================= */
    function readFeatureFID(f){
      return String(f.properties?.fid ?? f.properties?.FID ?? f.id ?? "");
    }

    function readFeatureDitta(f){
      return String(f.properties?.Ditta ?? f.properties?.ditta ?? "—");
    }

    function readFeatureTotaleM(f){
      // Se hai già la lunghezza nel geojson, metti il nome del campo qui:
      // es: f.properties.Lunghezza_m
      const p = f.properties || {};
      const candidates = [
        p.Lunghezza_m, p.lunghezza_m, p.length_m, p.Len_m, p.Lunghezza
      ];
      for(const c of candidates){
        if(Number.isFinite(Number(c))) return Number(c);
      }
      // fallback: 0 (se vuoi calcolo geometrico, lo aggiungiamo)
      return 0;
    }

    /* =========================================================
       #--AGGREGAZIONE PER DITTA--#
       Output per ogni ditta:
         { ditta, tronchiCount, totM, posatiM, perc, mDalBaseline, deltaPerc }
       + global summary analogo.
       ========================================================= */
    function computeAggregatesByDitta(date){
      const baseDate = CONFIG.BASELINE_DATE;

      const posatiNow = getPosatiMapForDate(date);
      const posatiBase = getPosatiMapForDate(baseDate);

      const byDitta = new Map();
      const allFeatures = state.geojson.features || [];

      for(const f of allFeatures){
        const fid = readFeatureFID(f);
        const ditta = readFeatureDitta(f);
        const totM = safeNum(readFeatureTotaleM(f));

        const now = safeNum(posatiNow.get(fid));
        const base = safeNum(posatiBase.get(fid));
        const mDelta = now - base;

        if(!byDitta.has(ditta)){
          byDitta.set(ditta, {
            ditta,
            tronchiCount: 0,
            totM: 0,
            posatiM: 0,
            basePosatiM: 0,
            mDalBaseline: 0
          });
        }
        const row = byDitta.get(ditta);
        row.tronchiCount += 1;
        row.totM += totM;
        row.posatiM += now;
        row.basePosatiM += base;
        row.mDalBaseline += mDelta;
      }

      const rows = Array.from(byDitta.values()).map(r => {
        const perc = r.totM > 0 ? (r.posatiM / r.totM) * 100 : 0;
        const basePerc = r.totM > 0 ? (r.basePosatiM / r.totM) * 100 : 0;
        const deltaPerc = perc - basePerc;
        return {
          ditta: r.ditta,
          tronchiCount: r.tronchiCount,
          totM: r.totM,
          posatiM: r.posatiM,
          perc,
          mDalBaseline: r.mDalBaseline,
          deltaPerc
        };
      });

      // ordine: % desc, poi posati desc
      rows.sort((a,b) => (b.perc - a.perc) || (b.posatiM - a.posatiM));

      // summary globale
      const summary = rows.reduce((acc, r) => {
        acc.ditteCount += 1;
        acc.tronchiCount += r.tronchiCount;
        acc.totM += r.totM;
        acc.posatiM += r.posatiM;
        acc.mDalBaseline += r.mDalBaseline;
        return acc;
      }, { ditteCount:0, tronchiCount:0, totM:0, posatiM:0, mDalBaseline:0 });

      summary.perc = summary.totM > 0 ? (summary.posatiM / summary.totM) * 100 : 0;

      // Δ% globale dal baseline (confronto su stesso totale)
      // NB: sommiamo le posate baseline ricostruendole dai tronchi (come sopra)
      const baseTotalPosati = rows.reduce((acc, r) => {
        // ricaviamo base posati dalla formula: basePerc = perc - deltaPerc => basePerc
        // ma per evitare arrotondamenti, ricalcoliamo: basePosati = posati - mDalBaseline
        return acc + (r.posatiM - r.mDalBaseline);
      }, 0);

      const basePercGlobal = summary.totM > 0 ? (baseTotalPosati / summary.totM) * 100 : 0;
      summary.deltaPerc = summary.perc - basePercGlobal;

      return { rows, summary };
    }

    /* =========================================================
       #--RENDER TABELLA DITTE--#
       Aggiunta colonna: “m dal 27/01”
       ========================================================= */
    function renderDitteTable(rows){
      const tbody = document.getElementById("tbodyDitte");
      tbody.innerHTML = "";

      for(const r of rows){
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${escapeHtml(r.ditta)}</td>
          <td>${r.tronchiCount}</td>
          <td>${fmtMeters(r.totM)}</td>
          <td>${fmtMeters(r.posatiM)}</td>
          <td>${fmtPerc(r.perc)}%</td>
          <td>${fmtMeters(r.mDalBaseline)}</td>
          <td>${fmtPerc(r.deltaPerc, true)}%</td>
        `;
        tbody.appendChild(tr);
      }
    }

    /* =========================================================
       #--RENDER SOMMA (solo se Comprimi = ON)--#
       Aggiunta colonna: “m dal 27/01”
       ========================================================= */
    function setSummaryVisibility(isCompressed){
      const row = document.getElementById("summaryRow");
      row.classList.toggle("is-hidden", !isCompressed);
      row.setAttribute("aria-hidden", String(!isCompressed));
    }

    function renderSummary(summary){
      document.getElementById("baselineLabel").textContent = CONFIG.BASELINE_DATE;

      document.getElementById("sumTronchi").textContent = summary.tronchiCount;
      document.getElementById("sumDitte").textContent   = summary.ditteCount;

      document.getElementById("sumTot").textContent     = `${fmtMeters(summary.totM)} m`;
      document.getElementById("sumPosati").textContent  = `${fmtMeters(summary.posatiM)} m`;
      document.getElementById("sumPerc").textContent    = `${fmtPerc(summary.perc)}%`;

      // NUOVO: metri dal baseline
      document.getElementById("sumBaseDate").textContent  = CONFIG.BASELINE_DATE;
      document.getElementById("sumBaseDate2").textContent = CONFIG.BASELINE_DATE;
      document.getElementById("sumMDelta").textContent    = `${fmtMeters(summary.mDalBaseline)} m`;

      document.getElementById("sumDeltaPerc").textContent = `${fmtPerc(summary.deltaPerc, true)}%`;
    }

    /* =========================================================
       #--MAPPA: inizializzazione + layer GeoJSON--#
       - Stile semplice, popup con info tronco
       ========================================================= */
    function initMap(){
      state.map = L.map("map", { zoomControl:true });

      // Base map (OSM)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 20,
        attribution: "&copy; OpenStreetMap"
      }).addTo(state.map);
    }

    function renderMapLayer(date){
      if(state.layerTronchi){
        state.layerTronchi.remove();
        state.layerTronchi = null;
      }

      const posatiNow = getPosatiMapForDate(date);

      state.layerTronchi = L.geoJSON(state.geojson, {
        style: (feature) => {
          // niente colori fissi: linewidth variabile leggerissima
          const fid = readFeatureFID(feature);
          const pos = safeNum(posatiNow.get(fid));
          const tot = safeNum(readFeatureTotaleM(feature));
          const perc = tot > 0 ? (pos / tot) : 0;

          return {
            weight: 2 + Math.min(3, perc * 3),
            opacity: 0.85
          };
        },
        onEachFeature: (feature, layer) => {
          const fid = readFeatureFID(feature);
          const ditta = readFeatureDitta(feature);
          const tot = safeNum(readFeatureTotaleM(feature));
          const pos = safeNum(posatiNow.get(fid));
          const perc = tot > 0 ? (pos/tot)*100 : 0;

          layer.bindPopup(`
            <div style="font-family:${getComputedStyle(document.documentElement).getPropertyValue("--mono")};font-size:12px;line-height:1.35;">
              <div><b>Tronco</b>: ${escapeHtml(fid)}</div>
              <div><b>Ditta</b>: ${escapeHtml(ditta)}</div>
              <div><b>Tot</b>: ${fmtMeters(tot)} m</div>
              <div><b>Posati</b>: ${fmtMeters(pos)} m</div>
              <div><b>%</b>: ${fmtPerc(perc)}%</div>
            </div>
          `);
        }
      }).addTo(state.map);

      // Fit bounds solo al primo render (o se preferisci sempre)
      if(!state._didFit){
        const b = state.layerTronchi.getBounds();
        if(b.isValid()) state.map.fitBounds(b.pad(0.08));
        state._didFit = true;
      }
    }

    /* =========================================================
       #--UI: date select + toggle Comprimi--#
       ========================================================= */
    function fillDateSelect(dates){
      const sel = document.getElementById("dateSelect");
      sel.innerHTML = "";
      for(const d of dates){
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        sel.appendChild(opt);
      }
    }

    function wireUI(){
      const sel = document.getElementById("dateSelect");
      const btn = document.getElementById("btnComprimi");

      sel.addEventListener("change", () => {
        state.selectedDate = sel.value;
        rerenderAll();
      });

      btn.addEventListener("click", () => {
        state.isCompressed = !state.isCompressed;
        btn.textContent = `Comprimi: ${state.isCompressed ? "ON" : "OFF"}`;

        // richiesto: la “somma” si vede SOLO quando Comprimi è ON
        setSummaryVisibility(state.isCompressed);

        rerenderAll();
      });
    }

    /* =========================================================
       #--RENDER COMPLETO (tabella + somma + mappa)--#
       ========================================================= */
    function rerenderAll(){
      const { rows, summary } = computeAggregatesByDitta(state.selectedDate);

      // tabella (sempre): mantiene spaziature “da tabella”
      renderDitteTable(rows);

      // somma (solo se comprimi ON)
      if(state.isCompressed){
        renderSummary(summary);
      }

      // mappa
      renderMapLayer(state.selectedDate);
    }

    /* =========================================================
       #--BOOTSTRAP (start app)--#
       ========================================================= */
    async function main(){
      initMap();

      // carica dati
      const [geo, avzRaw] = await Promise.all([
        loadJSON(CONFIG.GEOJSON_URL),
        loadJSON(CONFIG.AVANZ_URL)
      ]);

      state.geojson = geo;
      state.avanzamento = normalizeAvanzamento(avzRaw);

      // dates disponibili
      state.dates = state.avanzamento.dates.slice();

      // se baseline non è presente, la UI comunque lo mostra ma delta sarà “0” dove mancante
      // seleziona l’ultima data disponibile di default
      state.selectedDate = state.dates[state.dates.length - 1] || CONFIG.BASELINE_DATE;

      // UI
      fillDateSelect(state.dates);
      document.getElementById("dateSelect").value = state.selectedDate;

      // baseline labels
      document.getElementById("baselineLabel").textContent = CONFIG.BASELINE_DATE;
      document.getElementById("sumBaseDate").textContent = CONFIG.BASELINE_DATE;
      document.getElementById("sumBaseDate2").textContent = CONFIG.BASELINE_DATE;

      // somma nascosta di default (Comprimi OFF)
      setSummaryVisibility(false);

      wireUI();
      rerenderAll();
    }

    /* =========================================================
       #--UTIL: escape HTML (sicurezza popup/tabella)--#
       ========================================================= */
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // avvio
    main().catch(err => {
      console.error(err);
      alert("Errore caricamento dati. Apri la console (F12) per dettagli.\n\n" + err.message);
    });
  </script>
</body>
</html>
