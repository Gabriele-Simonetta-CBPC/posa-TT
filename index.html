<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Avanzamento posa condotta – PNRR</title>

<link rel="icon" href="data:,">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
  :root{
    --bg:#ffffff;
    --fg:#111;
    --muted:#666;
    --panel:#fff;
    --border:#ddd;
    --shadow: 0 8px 28px rgba(0,0,0,.12);
  }

  body{ margin:0; font-family: Arial, sans-serif; color:var(--fg); background:var(--bg); }
  header{
    padding: 10px 14px;
    border-bottom:1px solid var(--border);
    background:#fff;
  }

  .topline{
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
    flex-wrap:wrap;
  }

  .title{
    max-width: 1200px;
    line-height: 1.25;
    font-size: 14px;
  }
  .title b{ font-size: 16px; display:block; margin-bottom:4px; }
  .meta{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    margin-top:6px;
    color:var(--muted);
    font-size:12px;
  }
  .pill{
    border:1px solid var(--border);
    border-radius: 999px;
    padding: 4px 10px;
    background:#f7f7f7;
  }

  .logos{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .logos img{
    height:42px;
    width:auto;
    object-fit:contain;
    border:1px solid #eee;
    border-radius:10px;
    padding:6px 8px;
    background:#fff;
  }

  #map{ height: calc(100vh - 122px); }

  /* Overlay table */
  .overlay{
    position: absolute;
    top: 135px;
    right: 14px;
    width: min(520px, calc(100vw - 28px));
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: var(--shadow);
    overflow:hidden;
    z-index: 999;
  }
  .overlay-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 10px 12px;
    border-bottom:1px solid var(--border);
    background:#fafafa;
    gap:10px;
  }
  .overlay-header .h{
    font-weight:700;
    font-size: 13px;
  }
  .overlay-header button{
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    padding:6px 10px;
    cursor:pointer;
    font-size:12px;
  }

  .overlay-body{
    max-height: 55vh;
    overflow:auto;
  }

  table{
    width:100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  th, td{
    padding: 8px 8px;
    border-bottom:1px solid #eee;
    text-align:right;
    white-space:nowrap;
  }
  th{
    position: sticky;
    top:0;
    background:#fff;
    z-index: 2;
    border-bottom:1px solid var(--border);
    font-size: 12px;
  }
  td:first-child, th:first-child,
  td:nth-child(2), th:nth-child(2){
    text-align:left;
  }
  .swatch{
    display:inline-block;
    width:10px; height:10px;
    border-radius: 999px;
    margin-right:6px;
    vertical-align:middle;
  }

  /* Mobile tweaks */
  @media (max-width: 720px){
    .logos img{ height:34px; }
    #map{ height: calc(100vh - 168px); }
    .overlay{ top: 182px; left: 14px; right: 14px; width:auto; }
  }
</style>
</head>

<body>
<header>
  <div class="topline">
    <div class="title">
      <b>Schema irriguo Tidone – Avanzamento posa condotta</b>
      Piano Nazionale di Ripresa e Resilienza (PNRR). Missione 2 - Componente 4 - Investimento 4.3 – Investimenti nella resilienza dell’agrosistema irriguo per una migliore gestione delle risorse idriche – finanziato dall’Unione Europea – Next Generation EU. Intervento: Schema irriguo Tidone: interventi di risparmio idrico per il contrasto alla siccità e adeguamenti funzionali del sistema adduzione in sponda sinistra e destra Tidone. Codice intervento: 08-05-5703-847. Decreto di concessione del contributo pubblico di finanziamento: Decreto MIPAAF–DISR 01 – Prot. 0484456 del 30/09/2022. Importo complessivo € 7.666.906,95. CUP G99J21006930005. :contentReference[oaicite:1]{index=1}
      <div class="meta">
        <span id="status" class="pill">caricamento…</span>
        <span id="updated" class="pill"></span>
        <span class="pill">Dashboard pubblica</span>
      </div>
    </div>

    <div class="logos">
      <!-- Carica questi file nel repo in /assets/ -->
      <img src="assets/italiadomani.png" alt="Italia Domani">
      <img src="assets/masaf.png" alt="MASAF">
      <img src="assets/nextgenerationeu.png" alt="NextGenerationEU">
      <img src="assets/consorzio.png" alt="Consorzio di Bonifica di Piacenza">
    </div>
  </div>
</header>

<div id="map"></div>

<!-- Overlay tabella -->
<div class="overlay" id="overlay">
  <div class="overlay-header">
    <div class="h">Avanzamento per tronco</div>
    <button id="toggle">Nascondi</button>
  </div>
  <div class="overlay-body">
    <table>
      <thead>
        <tr>
          <th>Tronco</th>
          <th>Ditta</th>
          <th>Tot (m)</th>
          <th>Posati (m)</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  // ========= CONFIG =========
  const FILE_TRONCHI = "tronchi.geojson";
  const FILE_AVANZ   = "avanzamento.json";

  // >>> QUI risolvi il tuo problema:
  // se il 100% va "a sinistra", metti true
  const REVERSE_PROGRESS = true;

  // Palette (colori diversi per tronco)
  const PALETTE = ["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#a65628","#f781bf","#999999"];

  const statusEl  = document.getElementById("status");
  const updatedEl = document.getElementById("updated");
  const tbody     = document.getElementById("tbody");

  const setStatus = (t) => statusEl.textContent = t;
  const setUpdated = (t) => updatedEl.textContent = t;

  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Anti-cache forte
  const CB = Date.now();

  // Helpers
  const getTroncoId = (p) => p?.tronco ?? p?.Tronco ?? p?.TRONCO ?? null;
  const getDitta    = (p) => p?.ditta ?? p?.Ditta ?? p?.DITTA ?? "";

  function colorForTronco(id){
    // stabile: stesso tronco -> stesso colore
    const keys = ["PV","1","2","3-1","3-2","4","5"];
    const idx = Math.max(0, keys.indexOf(String(id)));
    return PALETTE[idx % PALETTE.length];
  }

  function fmt(n){ return (Number(n)||0).toFixed(2); }

  // sanitize coordinate to numbers (evita turf crash)
  function toValidPoint(pt){
    if(!Array.isArray(pt) || pt.length < 2) return null;
    const lng = Number(pt[0]), lat = Number(pt[1]);
    if(!Number.isFinite(lng) || !Number.isFinite(lat)) return null;
    return [lng, lat];
  }
  function sanitizeFeature(f){
    const g = f?.geometry;
    if(!g) return null;

    if(g.type === "LineString"){
      const clean = (g.coordinates||[]).map(toValidPoint).filter(Boolean);
      if(clean.length < 2) return null;
      return { ...f, geometry:{ type:"LineString", coordinates: clean } };
    }

    if(g.type === "MultiLineString"){
      const parts = (g.coordinates||[])
        .map(line => (line||[]).map(toValidPoint).filter(Boolean))
        .filter(line => line.length >= 2);
      if(parts.length < 1) return null;
      return { ...f, geometry:{ type:"MultiLineString", coordinates: parts } };
    }

    return null;
  }

  function progressPoint(feature, done, tot){
    const perc = (tot > 0) ? Math.min(done/tot, 1) : 0;

    // lunghezza totale
    const totalKm = turf.length(feature, {units:"kilometers"});
    if(!Number.isFinite(totalKm) || totalKm <= 0) return { ok:false, perc, reason:"lunghezza 0" };

    // distanza lungo linea:
    // REVERSE_PROGRESS = true -> 100% va dall'altro lato (risolve il tuo caso)
    const eff = REVERSE_PROGRESS ? (1 - perc) : perc;
    const distKm = totalKm * eff;

    try{
      const pt = turf.along(feature, distKm, {units:"kilometers"});
      return { ok:true, perc, point: pt };
    }catch(e){
      return { ok:false, perc, reason: e?.message || String(e) };
    }
  }

  // Overlay toggle
  const overlay = document.getElementById("overlay");
  const btn = document.getElementById("toggle");
  let hidden = false;
  btn.addEventListener("click", () => {
    hidden = !hidden;
    overlay.style.height = hidden ? "44px" : "";
    overlay.querySelector(".overlay-body").style.display = hidden ? "none" : "block";
    btn.textContent = hidden ? "Mostra" : "Nascondi";
  });

  setStatus("caricamento…");

  Promise.all([
    fetch(FILE_TRONCHI + "?cb=" + CB).then(r => { if(!r.ok) throw new Error("tronchi.geojson HTTP " + r.status); return r.json(); }),
    fetch(FILE_AVANZ   + "?cb=" + CB).then(r => { if(!r.ok) throw new Error("avanzamento.json HTTP " + r.status); return r.json(); })
  ])
  .then(([geo, avanz]) => {
    setStatus("dati caricati");
    setUpdated("aggiornato: " + new Date().toLocaleString("it-IT"));

    const cleanFeatures = (geo.features||[]).map(sanitizeFeature).filter(Boolean);
    const cleanFC = { type:"FeatureCollection", features: cleanFeatures };

    // Disegna linee colorate per tronco
    const layerLines = L.geoJSON(cleanFC, {
      style: (f) => {
        const id = getTroncoId(f.properties);
        return { color: colorForTronco(id), weight: 4, opacity: 0.9 };
      },
      onEachFeature: (f, layer) => {
        const id = getTroncoId(f.properties) ?? "?";
        const ditta = getDitta(f.properties);
        layer.bindTooltip(`Tronco ${id}${ditta ? " - " + ditta : ""}`);
      }
    }).addTo(map);

    if(cleanFeatures.length) map.fitBounds(layerLines.getBounds());

    // Popola tabella + punti
    tbody.innerHTML = "";

    cleanFeatures.forEach(f => {
      const id = getTroncoId(f.properties);
      if(!id) return;

      const ditta = getDitta(f.properties);
      const dati = avanz[String(id)];
      if(!dati) return;

      const tot  = Number(dati.tot)||0;
      const done = Number(dati.done)||0;
      const perc = tot > 0 ? (done/tot)*100 : 0;

      const col = colorForTronco(id);

      // riga tabella
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="swatch" style="background:${col}"></span>${id}</td>
        <td>${ditta || ""}</td>
        <td>${fmt(tot)}</td>
        <td>${fmt(done)}</td>
        <td>${perc.toFixed(1)}%</td>
      `;
      tbody.appendChild(tr);

      // punto avanzamento
      const res = progressPoint(f, done, tot);
      if(!res.ok || !res.point) return;

      const [lng, lat] = res.point.geometry.coordinates;

      L.circleMarker([lat, lng], {
        radius: 7,
        color: col,
        fillColor: col,
        fillOpacity: 1
      }).addTo(map).bindPopup(`
        <b>Tronco ${id}</b><br>
        ${ditta ? `<i>${ditta}</i><br>` : ""}
        ${fmt(done)} / ${fmt(tot)} m<br>
        ${(res.perc*100).toFixed(1)} %
      `);
    });
  })
  .catch(err => {
    console.error(err);
    setStatus("errore");
    alert(err.message || "Errore nel caricamento");
  });
})();
</script>
</body>
</html>
